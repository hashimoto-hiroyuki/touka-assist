"""
糖化アンケートOCR設定ファイル v2.1
座標定義・API設定・マッピング情報

変更履歴:
  v2.1 - 質問2に「□以降、QRコードで回答」チェックボックス追加
       - 質問2_行全体（確認UI用）領域追加
       - 矛盾検出ロジック用フラグ追加
  v2.0 - 医師入力欄（質問14・15）追加
"""

# ============================================
# 基準点検出設定（2点参照方式）
# ============================================

# 質問1と質問15を基準点として傾き補正
ANCHOR_POINTS = {
    "質問1": {
        "search_area": {"x": 0.0, "y": 0.10, "width": 0.12, "height": 0.06},
        "text": "質問",
        "description": "質問1ラベル位置（上側基準点）"
    },
    "質問15": {
        "search_area": {"x": 0.0, "y": 0.85, "width": 0.12, "height": 0.06},
        "text": "質問",
        "description": "質問15ラベル位置（下側基準点）"
    },
}

# ============================================
# 相対座標定義 (RELATIVE_REGIONS)
# 基準: ページ全体に対する比率 (0.0〜1.0)
# A4 300DPI: 2480 x 3508 px
# ============================================

RELATIVE_REGIONS = {
    # ============================================
    # ヘッダー部分
    # ============================================
    "医療機関名": {
        "x": 0.79, "y": 0.052, "width": 0.19, "height": 0.020,
        "type": "printed_text",
        "description": "右上の医療機関名（印刷）"
    },
    "患者ID": {
        "x": 0.545, "y": 0.060, "width": 0.265, "height": 0.018,
        "type": "handwritten_boxes",
        "boxes": 8,
        "description": "患者さんID（8桁ボックス）"
    },

    # ============================================
    # 質問1: 名前（カタカナ）
    # ============================================
    "質問1_氏": {
        "x": 0.19, "y": 0.131, "width": 0.22, "height": 0.017,
        "type": "handwritten_katakana",
        "description": "名前（カタカナ）氏"
    },
    "質問1_名": {
        "x": 0.48, "y": 0.131, "width": 0.20, "height": 0.017,
        "type": "handwritten_katakana",
        "description": "名前（カタカナ）名"
    },

    # ============================================
    # 質問2: 生年月日 + QRコード回答チェック
    # ============================================

    # --- OCR処理用（個別フィールド）---
    "質問2_元号": {
        "x": 0.15, "y": 0.160, "width": 0.13, "height": 0.017,
        "type": "circled_selection",
        "options": ["昭和", "平成", "令和"],
        "description": "生年月日の元号（丸で囲む）"
    },
    "質問2_年": {
        "x": 0.28, "y": 0.160, "width": 0.04, "height": 0.017,
        "type": "handwritten_number",
        "description": "生年月日の年"
    },
    "質問2_月": {
        "x": 0.37, "y": 0.160, "width": 0.03, "height": 0.017,
        "type": "handwritten_number",
        "description": "生年月日の月"
    },
    "質問2_日": {
        "x": 0.42, "y": 0.160, "width": 0.03, "height": 0.017,
        "type": "handwritten_number",
        "description": "生年月日の日"
    },

    # --- v2.1新規: QRコード回答チェックボックス（OCR処理用）---
    "質問2_QRコード回答": {
        "x": 0.772, "y": 0.153, "width": 0.038, "height": 0.028,
        "type": "checkbox_single",
        "options": ["チェックあり", "チェックなし"],
        "description": "「以降、QRコードで回答」チェックボックス",
        "validation": {
            "rule": "qr_birthdate_consistency",
            "description": "チェック有の場合、生年月日欄が空欄であることが期待される"
        }
    },

    # --- v2.1新規: 行全体（確認UI表示用）---
    "質問2_行全体": {
        "x": 0.03, "y": 0.150, "width": 0.96, "height": 0.032,
        "type": "review_image",
        "description": "質問2の行全体（人による確認用切り出し画像）",
        "review_only": True,  # OCR処理対象外、確認UI用のみ
    },

    # ============================================
    # 質問3: 性別
    # ============================================
    "質問3_性別": {
        "x": 0.10, "y": 0.197, "width": 0.25, "height": 0.016,
        "type": "checkbox_single",
        "options": ["男", "女", "回答しない"],
        "description": "性別"
    },

    # ============================================
    # 質問4: 血液型
    # ============================================
    "質問4_血液型": {
        "x": 0.10, "y": 0.230, "width": 0.45, "height": 0.016,
        "type": "checkbox_single",
        "options": ["A型", "B型", "O型", "AB型", "わからない"],
        "description": "血液型"
    },

    # ============================================
    # 質問5: 身長・体重
    # ============================================
    "質問5_身長": {
        "x": 0.10, "y": 0.265, "width": 0.15, "height": 0.016,
        "type": "handwritten_number",
        "unit": "cm",
        "description": "身長"
    },
    "質問5_体重": {
        "x": 0.40, "y": 0.265, "width": 0.15, "height": 0.016,
        "type": "handwritten_number",
        "unit": "kg",
        "description": "体重"
    },

    # ============================================
    # 質問6: 糖尿病（黒塗り）
    # ============================================
    "質問6_糖尿病": {
        "x": 0.10, "y": 0.315, "width": 0.72, "height": 0.016,
        "type": "filled_box",
        "options": ["なし", "5年未満", "5〜10年前", "10年以上前", "わからない"],
        "description": "糖尿病チェックボックス（黒塗り）"
    },

    # ============================================
    # 質問7: 脂質異常症（黒塗り）
    # ============================================
    "質問7_脂質異常症": {
        "x": 0.10, "y": 0.350, "width": 0.72, "height": 0.016,
        "type": "filled_box",
        "options": ["なし", "5年未満", "5〜10年前", "10年以上前", "わからない"],
        "description": "脂質異常症チェックボックス（黒塗り）"
    },

    # ============================================
    # 質問8: 兄弟に糖尿病歴
    # ============================================
    "質問8_兄弟糖尿病歴": {
        "x": 0.10, "y": 0.385, "width": 0.72, "height": 0.016,
        "type": "filled_box",
        "options": ["はい", "いいえ", "わからない"],
        "description": "兄弟に糖尿病歴"
    },

    # ============================================
    # 質問9: 両親に糖尿病歴
    # ============================================
    "質問9_両親糖尿病歴": {
        "x": 0.10, "y": 0.420, "width": 0.72, "height": 0.016,
        "type": "filled_box",
        "options": ["はい", "いいえ", "わからない"],
        "description": "両親に糖尿病歴"
    },

    # ============================================
    # 質問10: 運動習慣
    # ============================================
    "質問10_運動しない": {
        "x": 0.10, "y": 0.455, "width": 0.50, "height": 0.016,
        "type": "filled_box",
        "options": ["はい", "いいえ"],
        "description": "ほとんど運動しない"
    },

    # ============================================
    # 質問11: お菓子頻度
    # ============================================
    "質問11_お菓子頻度": {
        "x": 0.06, "y": 0.500, "width": 0.70, "height": 0.035,
        "type": "filled_box",
        "options": ["ほぼ毎日", "週2~3回", "週1回以下または食べない"],
        "description": "お菓子・スイーツ頻度"
    },

    # ============================================
    # 質問12: 飲み物
    # ============================================
    "質問12_飲み物": {
        "x": 0.04, "y": 0.555, "width": 0.70, "height": 0.060,
        "type": "filled_box",
        "options": ["有糖飲料", "無糖飲料"],
        "description": "最もよく飲む飲み物"
    },

    # ============================================
    # 質問13: 飲酒習慣
    # ============================================
    "質問13_飲酒": {
        "x": 0.04, "y": 0.630, "width": 0.72, "height": 0.170,
        "type": "complex_drinking",
        "description": "飲酒習慣全体"
    },

    # ============================================
    # 【医師入力欄】質問14: 歯の抜去位置
    # ============================================
    "質問14_歯の抜去位置": {
        "x": 0.10, "y": 0.846, "width": 0.50, "height": 0.020,
        "type": "tooth_extraction",
        "description": "歯の抜去位置（3つの記入ボックス）"
    },

    # ============================================
    # 【医師入力欄】質問15: コメント欄
    # ============================================
    "質問15_コメント欄": {
        "x": 0.04, "y": 0.875, "width": 0.70, "height": 0.055,
        "type": "handwritten_text",
        "description": "HbA1c数値などコメント"
    },

    # ============================================
    # QRコード（アライメント用）
    # ============================================
    "QRコード": {
        "x": 0.85, "y": 0.870, "width": 0.13, "height": 0.10,
        "type": "qr_code",
        "description": "右下QRコード"
    },
}


# ============================================
# v2.1新規: 矛盾検出ルール（バリデーション）
# ============================================

VALIDATION_RULES = {
    "qr_birthdate_consistency": {
        "description": "QRコード回答チェック時の生年月日整合性",
        "check_fields": ["質問2_元号", "質問2_年", "質問2_月", "質問2_日"],
        "trigger_field": "質問2_QRコード回答",
        "trigger_value": True,
        "expected": "empty",  # QRチェック有なら生年月日は空欄が想定
        "severity": "warning",  # 矛盾時のフラグ: "warning" or "error"
        "message": "「QRコードで回答」にチェックがありますが、生年月日にも記入があります。確認してください。"
    },
}


# ============================================
# v2.1新規: 確認UI用グルーピング
# ============================================

REVIEW_GROUPS = {
    "質問2": {
        "display_image": "質問2_行全体",   # 確認UIで表示する画像領域
        "ocr_fields": [                      # OCR結果を表示するフィールド
            "質問2_元号",
            "質問2_年",
            "質問2_月",
            "質問2_日",
            "質問2_QRコード回答",
        ],
        "validation_rules": ["qr_birthdate_consistency"],
        "description": "生年月日 + QRコード回答チェック"
    },
}


# ============================================
# 医療機関マスタ
# ============================================

INSTITUTION_MASTER = [
    "北大附属病院",
    "旭川医大",
    "ホワイト歯科医院",
    "富良野",
    "アンドロメダ",
    "ウィダス",
    "サンドリア",
    "ジュノー2",
    "高台デンタル",
    "美瑛デンタル",
]


# ============================================
# 値変換マッピング
# ============================================

VALUE_MAPPINGS = {
    "糖尿病_診断": {
        "なし": "診断されていない",
        "5年未満": "3年以内",
        "5〜10年前": "10年以内",
        "10年以上前": "10年以上前",
        "わからない": "わからない"
    },
    "運動": {
        "はい": "ほとんどしない",
        "いいえ": "定期的にする",
    },
    "飲酒": {
        True: "週1回以上飲む",
        False: "ほとんど飲まない",
    },
}


# ============================================
# Claude API設定
# ============================================

CLAUDE_API = {
    "model": "claude-sonnet-4-20250514",
    "max_tokens": 4096,
    "temperature": 0,
}

OCR_PROMPT_TEMPLATE = """
この画像は糖化アンケートの一部です。以下の項目を読み取ってください。

【読み取り対象】
{field_description}

【回答形式】
JSON形式で回答してください。
- 読み取れた値は "value" キーに設定
- 信頼度は "confidence" キーに "high"/"medium"/"low" で設定
- 読み取れない場合は "value": null

【注意事項】
- 手書き文字は丁寧に判読してください
- チェックマーク（✓）や黒塗り（■）を検出してください
- 数字は半角で出力してください
- カタカナはそのまま出力してください

回答:
"""


# ============================================
# ファイルパス設定
# ============================================

PATHS = {
    "scan_data": "Scan Data",
    "checked_data": "Checked Data",
    "cropped_images": "cropped_images",
    "output_html": "cropped_images/verification.html",
    "output_json": "survey_result.json",
}
